# Ported from original Workshop mod (2782571928) with
# Extended with dynamic RP modifiers and event cooldown for the player.

initialize_dynamic_research_slots = {
	set_country_flag = dynamic_research_slots_initialized

	# Set mod metadata (version, compatibility signals) - must be first
	dr_set_mod_metadata = yes

	set_variable = { current_research_slots = amount_research_slots	}
	set_variable = { target_research_slots = 2 }
	set_variable = { removed_research_slots = 0 }

	# Allow other mods to signal compatibility or perform checks before initialization
	dr_check_compatibility_submods = yes

	# Apply all default configuration values (factory weights, thresholds, Easy Slots, game rules)
	dr_apply_research_config = yes

	if = {
		limit = {
			check_variable = { current_research_slots > target_research_slots }
		}
		set_variable = { removed_research_slots = var:current_research_slots }
		subtract_from_variable = { removed_research_slots = var:target_research_slots }
		set_research_slots = var:target_research_slots
		add_to_variable = { easy_research_slots = var:removed_research_slots }
	}

	# Rebuild effective thresholds (including Easy Slots) based on config.
	dr_rebuild_research_thresholds = yes

	# Allow submods to initialize their own variables or perform setup tasks.
	dr_initialize_submods = yes
}

calculate_modifiers_to_rp = {
	set_variable = { civilian_rp_modifier = 0 }
	set_variable = { military_rp_modifier = 0 }
	set_variable = { naval_rp_modifier = 0 }
	set_variable = { total_rp_modifier = 0 }

	# Apply modifier logic only if not disabled via flag.
	if = {
		limit = { NOT = { has_country_flag = dr_disable_rp_modifiers } }
		dr_apply_rp_modifier_logic = yes
	}
}


recalculate_dynamic_research_slots = {
	# Compatibility hooks: allow other mods to disable dynamic slot changes per country.
	# If the flag is set, we keep our bookkeeping in sync but skip all slot logic.
	# - dr_disable_dynamic_research_slots: completely disables the system (keeps variables in sync)
	# - dr_disable_research_slot_changes: disables slot changes but still calculates RP (for display/debug)
	if = {
		limit = { has_country_flag = dr_disable_dynamic_research_slots }
		set_variable = { current_research_slots = amount_research_slots }
	}

	if = {
		limit = { NOT = { has_country_flag = dr_disable_dynamic_research_slots } }

		if = {
			limit = {
				check_variable = {
					var = current_research_slots
					value = amount_research_slots
					compare = less_than
				}
			}
			set_variable = { temp = amount_research_slots }
			subtract_from_variable = { temp = current_research_slots }
			add_to_variable = { easy_research_slots = temp }
			country_event = dynamic_research_slots.2
			multiply_variable = { temp = -1 }
			add_research_slot = var:temp
		}

		# Rebuild effective thresholds after Easy Slot changes.
		dr_rebuild_research_thresholds = yes

		# Allow submods to adjust thresholds after Easy Slot logic is applied.
		dr_adjust_research_thresholds_submods = yes

		set_variable = { total_research_power = 0 }
		set_variable = { facility_research_power = 0 }

		# Allow submods to set factory modifiers before RP calculation.
		dr_apply_factory_modifiers_submods = yes

		set_variable = { base_civilian_research_power = 0 }
		add_to_variable = { base_civilian_research_power = research_power_per_civ }
		multiply_variable = { base_civilian_research_power = num_of_civilian_factories }
		set_variable = { temp = 1 }
		add_to_variable = { temp = civilian_rp_modifier }
		set_variable = { civilian_research_power = base_civilian_research_power }
		multiply_variable = { civilian_research_power = temp }


		set_variable = { base_military_research_power = 0 }
		add_to_variable = { base_military_research_power = research_power_per_mil }
		multiply_variable = { base_military_research_power = num_of_military_factories }
		set_variable = { temp = 1 }
		add_to_variable = { temp = military_rp_modifier }
		set_variable = { military_research_power = base_military_research_power }
		multiply_variable = { military_research_power = temp }

		set_variable = { base_naval_research_power = 0 }
		add_to_variable = { base_naval_research_power = research_power_per_nav }
		multiply_variable = { base_naval_research_power = num_of_naval_factories }
		set_variable = { temp = 1 }
		add_to_variable = { temp = naval_rp_modifier }
		set_variable = { naval_research_power = base_naval_research_power }
		multiply_variable = { naval_research_power = temp }

		add_to_variable = { total_research_power = civilian_research_power }
		add_to_variable = { total_research_power = military_research_power }
		add_to_variable = { total_research_power = naval_research_power }

		# Experimental Facilities give additional flat Research Power.
		# Building variables (nuclear_facility, naval_facility, air_facility, land_facility)
		# are only defined at state scope, so we need to iterate over owned states
		# and accumulate counts per facility type on the country.
		set_variable = { nuclear_facility_count = 0 }
		set_variable = { naval_facility_count = 0 }
		set_variable = { air_facility_count = 0 }
		set_variable = { land_facility_count = 0 }

		every_owned_state = {
			if = {
				limit = { nuclear_facility > 0 }
				ROOT = { add_to_variable = { nuclear_facility_count = 1 } }
			}
			if = {
				limit = { naval_facility > 0 }
				ROOT = { add_to_variable = { naval_facility_count = 1 } }
			}
			if = {
				limit = { air_facility > 0 }
				ROOT = { add_to_variable = { air_facility_count = 1 } }
			}
			if = {
				limit = { land_facility > 0 }
				ROOT = { add_to_variable = { land_facility_count = 1 } }
			}
		}

		# Allow submods to adjust facility counters (custom buildings, scripted logic, etc.).
		dr_collect_facility_counts_submods = yes

		# Apply per-facility RP based on accumulated counts (can be disabled via flag).
		if = {
			limit = { NOT = { has_country_flag = dr_disable_facility_rp } }
			
			if = {
				limit = {
					check_variable = {
						var = nuclear_facility_count
						value = 0
						compare = greater_than
					}
				}
				set_variable = { temp_facility_rp = nuclear_facility_count }
				multiply_variable = { temp_facility_rp = rp_per_nuclear_facility }
				add_to_variable = { total_research_power = temp_facility_rp }
				add_to_variable = { facility_research_power = temp_facility_rp }
			}
			if = {
				limit = {
					check_variable = {
						var = naval_facility_count
						value = 0
						compare = greater_than
					}
				}
				set_variable = { temp_facility_rp = naval_facility_count }
				multiply_variable = { temp_facility_rp = rp_per_naval_facility }
				add_to_variable = { total_research_power = temp_facility_rp }
				add_to_variable = { facility_research_power = temp_facility_rp }
			}
			if = {
				limit = {
					check_variable = {
						var = air_facility_count
						value = 0
						compare = greater_than
					}
				}
				set_variable = { temp_facility_rp = air_facility_count }
				multiply_variable = { temp_facility_rp = rp_per_air_facility }
				add_to_variable = { total_research_power = temp_facility_rp }
				add_to_variable = { facility_research_power = temp_facility_rp }
			}
			if = {
				limit = {
					check_variable = {
						var = land_facility_count
						value = 0
						compare = greater_than
					}
				}
				set_variable = { temp_facility_rp = land_facility_count }
				multiply_variable = { temp_facility_rp = rp_per_land_facility }
				add_to_variable = { total_research_power = temp_facility_rp }
				add_to_variable = { facility_research_power = temp_facility_rp }
			}
		}

		# Allow submods to convert facility counts (vanilla or custom) into RP (only if facility RP is enabled).
		if = {
			limit = { NOT = { has_country_flag = dr_disable_facility_rp } }
			dr_apply_facility_rp_submods = yes
		}

		# Apply global RP modifier (from war and alliance rules) - can be disabled via flag.
		if = {
			limit = { NOT = { has_country_flag = dr_disable_rp_modifiers } }
			set_variable = { temp = 1 }
			add_to_variable = { temp = total_rp_modifier }
			multiply_variable = { total_research_power = temp }
		}

		# Final hook for submods to adjust total RP after modifiers have been applied.
		dr_total_rp_modifier_submods = yes

		for_each_loop = {
			array = research_for_slot

			if = {
				limit = {
					check_variable = {
						var = total_research_power
						value = research_for_slot^i
						compare = greater_than_or_equals
					}
				}
				set_variable = { target_research_slots = i }
			}
		}

		if = {
			limit = {
				check_variable = {
					var = target_research_slots
					value = current_research_slots
					compare = not_equals
				}
			}

			# Slots have changed

			# Player: only show the event if no cooldown is running (or it has expired)
			if = {
				limit = { is_ai = no }

				if = {
					limit = {
						OR = {
							NOT = { has_variable = dr_player_event_cooldown }
							check_variable = {
								var = dr_player_event_cooldown
								value = 0
								compare = less_than_or_equals
							}
						}
					}
					country_event = dynamic_research_slots.1
					set_variable = { dr_player_event_cooldown = 14 }
				}
			}

			# AI: can always fire the event (if used)
			if = {
				limit = { is_ai = yes }
				country_event = dynamic_research_slots.1
			}
		}

		set_variable = { max_research_slots = research_for_slot^num }
		subtract_from_variable = { max_research_slots = 1 }
		set_variable = { next_research_slot_at = 0 }
		if = {
			limit = {
				check_variable = {
					var = target_research_slots
					value = max_research_slots
					compare = less_than
				}
			}
			set_variable = { temp = target_research_slots }
			add_to_variable = { temp = 1 }
			set_variable = { next_research_slot_at = var:research_for_slot^temp }
		}

		# Allow disabling slot changes while keeping RP calculation active (for display/debug purposes).
		if = {
			limit = { NOT = { has_country_flag = dr_disable_research_slot_changes } }
			set_research_slots = var:target_research_slots
		}
		set_variable = { current_research_slots = amount_research_slots }
	}
}

# Submod hook: compatibility check - allows other mods to signal compatibility or perform checks before config is applied
dr_check_compatibility_submods = { }

# Submod hook: initialize custom variables or perform setup tasks during initialization (after config is applied)
dr_initialize_submods = { }

# Submod hook: adjust facility counters after vanilla counting pass
dr_collect_facility_counts_submods = { }

# Submod hook: convert facility counters into RP, or add additional RP sources
dr_apply_facility_rp_submods = { }

# Submod hook: set factory modifiers (civilian_rp_modifier, military_rp_modifier, naval_rp_modifier)
# before the factory RP calculation runs. These modifiers are applied multiplicatively.
dr_apply_factory_modifiers_submods = { }

# Submod hook: adjust research slot thresholds after Easy Slot logic has been applied.
# This allows tweaking thresholds based on custom logic without overriding the entire threshold array.
dr_adjust_research_thresholds_submods = { }

# Submod hook: tweak total RP after the vanilla global modifier is applied
dr_total_rp_modifier_submods = { }
