# Ported from original Workshop mod (2782571928) with
# zusätzlichem Event-Cooldown für den Spieler.

initialize_dynamic_research_slots = {
	set_country_flag = dynamic_research_slots_initialized

	set_variable = { current_research_slots = amount_research_slots	}
	set_variable = { target_research_slots = 2 }
	set_variable = { easy_research_slots = 2 }

	# Base RP weights per factory type
	set_variable = { research_power_per_civ = 3 }
	set_variable = { research_power_per_mil = 2 }
	set_variable = { research_power_per_nav = 2 }

	# Optional override via factory weights game rule
	if = {
		limit = { has_game_rule = { rule = DR_FACTORY_WEIGHTS_RULE option = DR_FACTORY_WEIGHTS_INDUSTRY } }
		set_variable = { research_power_per_civ = 4 }
		set_variable = { research_power_per_mil = 2 }
		set_variable = { research_power_per_nav = 1 }
	}
	if = {
		limit = { has_game_rule = { rule = DR_FACTORY_WEIGHTS_RULE option = DR_FACTORY_WEIGHTS_MILITARY } }
		set_variable = { research_power_per_civ = 2 }
		set_variable = { research_power_per_mil = 4 }
		set_variable = { research_power_per_nav = 2 }
	}
	if = {
		limit = { has_game_rule = { rule = DR_FACTORY_WEIGHTS_RULE option = DR_FACTORY_WEIGHTS_NAVAL } }
		set_variable = { research_power_per_civ = 2 }
		set_variable = { research_power_per_mil = 2 }
		set_variable = { research_power_per_nav = 4 }
	}

	add_to_array = { base_research_for_slot = 0 } 		#this doesnt correspond to a research slot, its for easier indexing
	add_to_array = { base_research_for_slot = 0 }			#1
	add_to_array = { base_research_for_slot = 0 }			#2
	add_to_array = { base_research_for_slot = 50 }		#3
	add_to_array = { base_research_for_slot = 200 }		#4
	add_to_array = { base_research_for_slot = 400 }		#5
	add_to_array = { base_research_for_slot = 700 }		#6
	add_to_array = { base_research_for_slot = 1000 }	#7
	add_to_array = { base_research_for_slot = 1500 }	#8
	add_to_array = { base_research_for_slot = 2000 }	#9
	add_to_array = { base_research_for_slot = 3000 }	#10

	add_to_array = { research_for_slot = 0 } 		#this doesnt correspond to a research slot, its for easier indexing
	add_to_array = { research_for_slot = 0 }		#1
	add_to_array = { research_for_slot = 0 }		#2
	add_to_array = { research_for_slot = 50 }		#3
	add_to_array = { research_for_slot = 200 }	#4
	add_to_array = { research_for_slot = 400 }	#5
	add_to_array = { research_for_slot = 700 }	#6
	add_to_array = { research_for_slot = 1000 }	#7
	add_to_array = { research_for_slot = 1500 }	#8
	add_to_array = { research_for_slot = 2000 }	#9
	add_to_array = { research_for_slot = 3000 }	#10


	set_variable = { removed_research_slots = 0 }
	set_variable = { easy_research_slot_coefficient = 0.6 }

	# Zusätzliche Easy Slots über Game Rule
	if = {
		limit = { has_game_rule = { rule = DR_EASY_SLOTS_RULE option = DR_EASY_SLOTS_PLUS_1 } }
		add_to_variable = { easy_research_slots = 1 }
	}
	if = {
		limit = { has_game_rule = { rule = DR_EASY_SLOTS_RULE option = DR_EASY_SLOTS_PLUS_2 } }
		add_to_variable = { easy_research_slots = 2 }
	}
	if = {
		limit = { has_game_rule = { rule = DR_EASY_SLOTS_RULE option = DR_EASY_SLOTS_PLUS_3 } }
		add_to_variable = { easy_research_slots = 3 }
	}
	if = {
		limit = { has_game_rule = { rule = DR_EASY_SLOTS_RULE option = DR_EASY_SLOTS_PLUS_4 } }
		add_to_variable = { easy_research_slots = 4 }
	}
	if = {
		limit = { has_game_rule = { rule = DR_EASY_SLOTS_RULE option = DR_EASY_SLOTS_PLUS_5 } }
		add_to_variable = { easy_research_slots = 5 }
	}

	# Optional: minor nations get an additional Easy Slot (controlled via game rule)
	if = {
		limit = {
			is_major = no
			has_game_rule = {
				rule = DR_MINOR_EASY_SLOTS_RULE
				option = DR_MINOR_EASY_SLOTS_ON
			}
		}
		add_to_variable = { easy_research_slots = 1 }
	}

	# Kostenfaktor der Easy Slots über Game Rule (Standard 60%)
	if = {
		limit = { has_game_rule = { rule = DR_EASY_COST_RULE option = DR_EASY_COST_10 } }
		set_variable = { easy_research_slot_coefficient = 0.1 }
	}
	if = {
		limit = { has_game_rule = { rule = DR_EASY_COST_RULE option = DR_EASY_COST_20 } }
		set_variable = { easy_research_slot_coefficient = 0.2 }
	}
	if = {
		limit = { has_game_rule = { rule = DR_EASY_COST_RULE option = DR_EASY_COST_30 } }
		set_variable = { easy_research_slot_coefficient = 0.3 }
	}
	if = {
		limit = { has_game_rule = { rule = DR_EASY_COST_RULE option = DR_EASY_COST_40 } }
		set_variable = { easy_research_slot_coefficient = 0.4 }
	}
	if = {
		limit = { has_game_rule = { rule = DR_EASY_COST_RULE option = DR_EASY_COST_50 } }
		set_variable = { easy_research_slot_coefficient = 0.5 }
	}
	# DR_EASY_COST_60 nutzt den Standardwert 0.6
	if = {
		limit = { has_game_rule = { rule = DR_EASY_COST_RULE option = DR_EASY_COST_70 } }
		set_variable = { easy_research_slot_coefficient = 0.7 }
	}
	if = {
		limit = { has_game_rule = { rule = DR_EASY_COST_RULE option = DR_EASY_COST_80 } }
		set_variable = { easy_research_slot_coefficient = 0.8 }
	}
	if = {
		limit = { has_game_rule = { rule = DR_EASY_COST_RULE option = DR_EASY_COST_90 } }
		set_variable = { easy_research_slot_coefficient = 0.9 }
	}
	if = {
		limit = { has_game_rule = { rule = DR_EASY_COST_RULE option = DR_EASY_COST_100 } }
		set_variable = { easy_research_slot_coefficient = 1.0 }
	}
	if = {
		limit = {
			check_variable = { current_research_slots > target_research_slots }
		}
		set_variable = { removed_research_slots = var:current_research_slots }
		subtract_from_variable = { removed_research_slots = var:target_research_slots }
		set_research_slots = var:target_research_slots
		add_to_variable = { easy_research_slots = var:removed_research_slots }
	}

	for_each_loop = {
		array = research_for_slot

		if = {
			limit = {
				check_variable = {
					var = easy_research_slots
					value = i
					compare = greater_than_or_equals
				}
			}
			set_variable = { temp = var:research_for_slot^i }
			multiply_variable = { temp = easy_research_slot_coefficient }
			#set_variable = { temp = 100 }
			set_variable = { research_for_slot^i = var:temp }
		}
	}
}

calculate_modifiers_to_rp = {
	set_variable = { civilian_rp_modifier = 0 }
	set_variable = { military_rp_modifier = 0 }
	set_variable = { naval_rp_modifier = 0 }
	set_variable = { total_rp_modifier = 0 }

	# War-time RP modifier (global, applied to total RP)
	if = {
		limit = {
			has_war = yes
			has_game_rule = { rule = DR_WAR_RP_RULE option = DR_WAR_RP_MINUS_5 }
		}
		add_to_variable = { total_rp_modifier = -0.05 }
	}
	if = {
		limit = {
			has_war = yes
			has_game_rule = { rule = DR_WAR_RP_RULE option = DR_WAR_RP_MINUS_10 }
		}
		add_to_variable = { total_rp_modifier = -0.10 }
	}
	if = {
		limit = {
			has_war = yes
			has_game_rule = { rule = DR_WAR_RP_RULE option = DR_WAR_RP_MINUS_15 }
		}
		add_to_variable = { total_rp_modifier = -0.15 }
	}
	if = {
		limit = {
			has_war = yes
			has_game_rule = { rule = DR_WAR_RP_RULE option = DR_WAR_RP_MINUS_20 }
		}
		add_to_variable = { total_rp_modifier = -0.20 }
	}
	if = {
		limit = {
			has_war = yes
			has_game_rule = { rule = DR_WAR_RP_RULE option = DR_WAR_RP_MINUS_25 }
		}
		add_to_variable = { total_rp_modifier = -0.25 }
	}
	if = {
		limit = {
			has_war = yes
			has_game_rule = { rule = DR_WAR_RP_RULE option = DR_WAR_RP_MINUS_30 }
		}
		add_to_variable = { total_rp_modifier = -0.30 }
	}

	# Alliance / faction RP modifier
	if = {
		limit = {
			is_in_faction = yes
			has_game_rule = { rule = DR_ALLIANCE_RP_RULE option = DR_ALLIANCE_RP_PLUS_5 }
		}
		add_to_variable = { total_rp_modifier = 0.05 }
	}
	if = {
		limit = {
			is_in_faction = yes
			has_game_rule = { rule = DR_ALLIANCE_RP_RULE option = DR_ALLIANCE_RP_PLUS_10 }
		}
		add_to_variable = { total_rp_modifier = 0.10 }
	}
	if = {
		limit = {
			is_in_faction = yes
			has_game_rule = { rule = DR_ALLIANCE_RP_RULE option = DR_ALLIANCE_RP_PLUS_15 }
		}
		add_to_variable = { total_rp_modifier = 0.15 }
	}
	if = {
		limit = {
			is_in_faction = yes
			has_game_rule = { rule = DR_ALLIANCE_RP_RULE option = DR_ALLIANCE_RP_PLUS_20 }
		}
		add_to_variable = { total_rp_modifier = 0.20 }
	}
	if = {
		limit = {
			is_in_faction = yes
			has_game_rule = { rule = DR_ALLIANCE_RP_RULE option = DR_ALLIANCE_RP_PLUS_25 }
		}
		add_to_variable = { total_rp_modifier = 0.25 }
	}
	if = {
		limit = {
			is_in_faction = yes
			has_game_rule = { rule = DR_ALLIANCE_RP_RULE option = DR_ALLIANCE_RP_PLUS_30 }
		}
		add_to_variable = { total_rp_modifier = 0.30 }
	}

	# Scientist effects
	# Approximate per-level bonuses using has_scientist_level thresholds (levels 1–5).

	# Nuclear / physics scientist – counted towards "civ" bucket
	if = { limit = { has_scientist_level = { specialization = specialization_nuclear level > 0 } } add_to_variable = { scientist_level_civ = 1 } }
	if = { limit = { has_scientist_level = { specialization = specialization_nuclear level > 1 } } add_to_variable = { scientist_level_civ = 1 } }
	if = { limit = { has_scientist_level = { specialization = specialization_nuclear level > 2 } } add_to_variable = { scientist_level_civ = 1 } }
	if = { limit = { has_scientist_level = { specialization = specialization_nuclear level > 3 } } add_to_variable = { scientist_level_civ = 1 } }
	if = { limit = { has_scientist_level = { specialization = specialization_nuclear level > 4 } } add_to_variable = { scientist_level_civ = 1 } }

	# Land + air scientists – counted towards "military" bucket
	if = { limit = { has_scientist_level = { specialization = specialization_land level > 0 } } add_to_variable = { scientist_level_mil = 1 } }
	if = { limit = { has_scientist_level = { specialization = specialization_land level > 1 } } add_to_variable = { scientist_level_mil = 1 } }
	if = { limit = { has_scientist_level = { specialization = specialization_land level > 2 } } add_to_variable = { scientist_level_mil = 1 } }
	if = { limit = { has_scientist_level = { specialization = specialization_land level > 3 } } add_to_variable = { scientist_level_mil = 1 } }
	if = { limit = { has_scientist_level = { specialization = specialization_land level > 4 } } add_to_variable = { scientist_level_mil = 1 } }

	if = { limit = { has_scientist_level = { specialization = specialization_air level > 0 } } add_to_variable = { scientist_level_mil = 1 } }
	if = { limit = { has_scientist_level = { specialization = specialization_air level > 1 } } add_to_variable = { scientist_level_mil = 1 } }
	if = { limit = { has_scientist_level = { specialization = specialization_air level > 2 } } add_to_variable = { scientist_level_mil = 1 } }
	if = { limit = { has_scientist_level = { specialization = specialization_air level > 3 } } add_to_variable = { scientist_level_mil = 1 } }
	if = { limit = { has_scientist_level = { specialization = specialization_air level > 4 } } add_to_variable = { scientist_level_mil = 1 } }

	# Naval scientist – counted towards "naval" bucket
	if = { limit = { has_scientist_level = { specialization = specialization_naval level > 0 } } add_to_variable = { scientist_level_nav = 1 } }
	if = { limit = { has_scientist_level = { specialization = specialization_naval level > 1 } } add_to_variable = { scientist_level_nav = 1 } }
	if = { limit = { has_scientist_level = { specialization = specialization_naval level > 2 } } add_to_variable = { scientist_level_nav = 1 } }
	if = { limit = { has_scientist_level = { specialization = specialization_naval level > 3 } } add_to_variable = { scientist_level_nav = 1 } }
	if = { limit = { has_scientist_level = { specialization = specialization_naval level > 4 } } add_to_variable = { scientist_level_nav = 1 } }

	# Total scientist level (for flat RP bonus)
	add_to_variable = { scientist_level_total = scientist_level_civ }
	add_to_variable = { scientist_level_total = scientist_level_mil }
	add_to_variable = { scientist_level_total = scientist_level_nav }

	# 1% extra RP from relevant factories per level
	set_variable = { temp = scientist_level_civ }
	multiply_variable = { temp = 0.01 }
	add_to_variable = { civilian_rp_modifier = temp }

	set_variable = { temp = scientist_level_mil }
	multiply_variable = { temp = 0.01 }
	add_to_variable = { military_rp_modifier = temp }

	set_variable = { temp = scientist_level_nav }
	multiply_variable = { temp = 0.01 }
	add_to_variable = { naval_rp_modifier = temp }

	# Recompute scientist levels for Experimental Facilities and clear per-factory modifiers.
	# This ensures scientists modify only Experimental Facility RP, not global factory RP.
	set_variable = { civilian_rp_modifier = 0 }
	set_variable = { military_rp_modifier = 0 }
	set_variable = { naval_rp_modifier = 0 }
	set_variable = { scientist_level_civ = 0 }
	set_variable = { scientist_level_mil = 0 }
	set_variable = { scientist_level_air = 0 }
	set_variable = { scientist_level_nav = 0 }
	set_variable = { scientist_level_total = 0 }

	# Nuclear / physics scientist – used for Physics Experimental Facility
	if = { limit = { has_scientist_level = { specialization = specialization_nuclear level > 0 } } add_to_variable = { scientist_level_civ = 1 } }
	if = { limit = { has_scientist_level = { specialization = specialization_nuclear level > 1 } } add_to_variable = { scientist_level_civ = 1 } }
	if = { limit = { has_scientist_level = { specialization = specialization_nuclear level > 2 } } add_to_variable = { scientist_level_civ = 1 } }
	if = { limit = { has_scientist_level = { specialization = specialization_nuclear level > 3 } } add_to_variable = { scientist_level_civ = 1 } }
	if = { limit = { has_scientist_level = { specialization = specialization_nuclear level > 4 } } add_to_variable = { scientist_level_civ = 1 } }

	# Land scientists – used for Land Experimental Facility
	if = { limit = { has_scientist_level = { specialization = specialization_land level > 0 } } add_to_variable = { scientist_level_mil = 1 } }
	if = { limit = { has_scientist_level = { specialization = specialization_land level > 1 } } add_to_variable = { scientist_level_mil = 1 } }
	if = { limit = { has_scientist_level = { specialization = specialization_land level > 2 } } add_to_variable = { scientist_level_mil = 1 } }
	if = { limit = { has_scientist_level = { specialization = specialization_land level > 3 } } add_to_variable = { scientist_level_mil = 1 } }
	if = { limit = { has_scientist_level = { specialization = specialization_land level > 4 } } add_to_variable = { scientist_level_mil = 1 } }

	# Air scientists – used for Air Experimental Facility
	if = { limit = { has_scientist_level = { specialization = specialization_air level > 0 } } add_to_variable = { scientist_level_air = 1 } }
	if = { limit = { has_scientist_level = { specialization = specialization_air level > 1 } } add_to_variable = { scientist_level_air = 1 } }
	if = { limit = { has_scientist_level = { specialization = specialization_air level > 2 } } add_to_variable = { scientist_level_air = 1 } }
	if = { limit = { has_scientist_level = { specialization = specialization_air level > 3 } } add_to_variable = { scientist_level_air = 1 } }
	if = { limit = { has_scientist_level = { specialization = specialization_air level > 4 } } add_to_variable = { scientist_level_air = 1 } }

	# Naval scientist – used for Naval Experimental Facility
	if = { limit = { has_scientist_level = { specialization = specialization_naval level > 0 } } add_to_variable = { scientist_level_nav = 1 } }
	if = { limit = { has_scientist_level = { specialization = specialization_naval level > 1 } } add_to_variable = { scientist_level_nav = 1 } }
	if = { limit = { has_scientist_level = { specialization = specialization_naval level > 2 } } add_to_variable = { scientist_level_nav = 1 } }
	if = { limit = { has_scientist_level = { specialization = specialization_naval level > 3 } } add_to_variable = { scientist_level_nav = 1 } }
	if = { limit = { has_scientist_level = { specialization = specialization_naval level > 4 } } add_to_variable = { scientist_level_nav = 1 } }

	# Total scientist level (for flat RP bonus)
	add_to_variable = { scientist_level_total = scientist_level_civ }
	add_to_variable = { scientist_level_total = scientist_level_mil }
	add_to_variable = { scientist_level_total = scientist_level_air }
	add_to_variable = { scientist_level_total = scientist_level_nav }
}

recalculate_dynamic_research_slots = {
	if = {
		limit = {
			check_variable = {
				var = current_research_slots
				value = amount_research_slots
				compare = less_than
			}
		}
		set_variable = { temp = amount_research_slots }
		subtract_from_variable = { temp = current_research_slots }
		add_to_variable = { easy_research_slots = temp }
		country_event = dynamic_research_slots.2
		multiply_variable = { temp = -1 }
		add_research_slot = var:temp
	}

	#this section is to be removed later, temporary workaround for easy research slots bug
	set_variable = { base_research_for_slot^0 = 0 } 		#this doesnt correspond to a research slot, its for easier indexing
	set_variable = { base_research_for_slot^1 = 0 }			#1
	set_variable = { base_research_for_slot^2 = 0 }			#2
	set_variable = { base_research_for_slot^3 = 50 }		#3
	set_variable = { base_research_for_slot^4 = 200 }		#4
	set_variable = { base_research_for_slot^5 = 400 }		#5
	set_variable = { base_research_for_slot^6 = 700 }		#6
	set_variable = { base_research_for_slot^7 = 1000 }	#7
	set_variable = { base_research_for_slot^8 = 1500 }	#8
	set_variable = { base_research_for_slot^9 = 2000 }	#9
	set_variable = { base_research_for_slot^10 = 3000 }	#10

	for_each_loop = {
		array = research_for_slot

		if = {
			limit = {
				check_variable = {
					var = easy_research_slots
					value = i
					compare = greater_than_or_equals
				}
			}
			set_variable = { temp = base_research_for_slot^i }
			#set_variable = { temp = 1000 }
			multiply_variable = { temp = easy_research_slot_coefficient }
			#set_variable = { temp = 100 }
			set_variable = { research_for_slot^i = var:temp }
		}
	}
	set_variable = { total_research_power = 0 }
	set_variable = { facility_research_power = 0 }

	set_variable = { base_civilian_research_power = 0 }
	add_to_variable = { base_civilian_research_power = research_power_per_civ }
	multiply_variable = { base_civilian_research_power = num_of_civilian_factories }
	set_variable = { temp = 1 }
	add_to_variable = { temp = civilian_rp_modifier }
	set_variable = { civilian_research_power = base_civilian_research_power }
	multiply_variable = { civilian_research_power = temp }


	set_variable = { base_military_research_power = 0 }
	add_to_variable = { base_military_research_power = research_power_per_mil }
	multiply_variable = { base_military_research_power = num_of_military_factories }
	set_variable = { temp = 1 }
	add_to_variable = { temp = military_rp_modifier }
	set_variable = { military_research_power = base_military_research_power }
	multiply_variable = { military_research_power = temp }

	set_variable = { base_naval_research_power = 0 }
	add_to_variable = { base_naval_research_power = research_power_per_nav }
	multiply_variable = { base_naval_research_power = num_of_naval_factories }
	set_variable = { temp = 1 }
	add_to_variable = { temp = naval_rp_modifier }
	set_variable = { naval_research_power = base_naval_research_power }
	multiply_variable = { naval_research_power = temp }

	add_to_variable = { total_research_power = civilian_research_power }
	add_to_variable = { total_research_power = military_research_power }
	add_to_variable = { total_research_power = naval_research_power }

	# Experimental Facilities give additional flat Research Power
	if = {
		limit = { nuclear_facility > 0 }
		add_to_variable = { total_research_power = 50 }
		add_to_variable = { facility_research_power = 50 }
	}
	if = {
		limit = { naval_facility > 0 }
		add_to_variable = { total_research_power = 35 }
		add_to_variable = { facility_research_power = 35 }
	}
	if = {
		limit = { air_facility > 0 }
		add_to_variable = { total_research_power = 35 }
		add_to_variable = { facility_research_power = 35 }
	}
	if = {
		limit = { land_facility > 0 }
		add_to_variable = { total_research_power = 35 }
		add_to_variable = { facility_research_power = 35 }
	}

	# Apply global RP modifier (from war and alliance rules)
	set_variable = { temp = 1 }
	add_to_variable = { temp = total_rp_modifier }
	multiply_variable = { total_research_power = temp }

	for_each_loop = {
		array = research_for_slot

		if = {
			limit = {
				check_variable = {
					var = total_research_power
					value = research_for_slot^i
					compare = greater_than_or_equals
				}
			}
			set_variable = { target_research_slots = i }
		}
	}

	if = {
		limit = {
			check_variable = {
				var = target_research_slots
				value = current_research_slots
				compare = not_equals
			}
		}

		# Slots haben sich geändert

		# Event nur, wenn kein Cooldown läuft (oder abgelaufen)
		if = {
			limit = { is_ai = no }

			if = {
				limit = {
					OR = {
						NOT = { has_variable = dr_player_event_cooldown }
						check_variable = {
							var = dr_player_event_cooldown
							value = 0
							compare = less_than_or_equals
						}
					}
				}
				country_event = dynamic_research_slots.1
				set_variable = { dr_player_event_cooldown = 14 }
			}
		}

		# Für KI kann das Event immer gefeuert werden
		if = {
			limit = { is_ai = yes }
			country_event = dynamic_research_slots.1
		}
	}

	set_variable = { max_research_slots = research_for_slot^num }
	subtract_from_variable = { max_research_slots = 1 }
	set_variable = { next_research_slot_at = 0 }
	if = {
		limit = {
			check_variable = {
				var = target_research_slots
				value = max_research_slots
				compare = less_than
			}
		}
		set_variable = { temp = target_research_slots }
		add_to_variable = { temp = 1 }
		set_variable = { next_research_slot_at = var:research_for_slot^temp }
	}

	set_research_slots = var:target_research_slots
	set_variable = { current_research_slots = amount_research_slots }
}
