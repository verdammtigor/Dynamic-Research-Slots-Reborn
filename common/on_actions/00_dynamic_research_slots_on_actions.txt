on_actions = {
  ###
  # Initialization at game start.
  # Set variables/flags but do not change slots yet.
  ###
  on_startup = {
    effect = {
      every_country = {
        initialize_dynamic_research_slots = yes
        calculate_modifiers_to_rp = yes

        # Show a one-time startup explanation for human players.
        if = {
          limit = { is_ai = no }
          country_event = dynamic_research_slots.6
        }

        # AI countries need an initial calculation at startup to set correct research slots.
        # After this, they use staggered updates (every ~14 days by default) for performance.
        if = {
          limit = { is_ai = yes }
          # Ensure AI update frequency variable exists (defensive check).
          if = {
            limit = { NOT = { has_variable = dr_ai_update_frequency } }
            set_variable = { dr_ai_update_frequency = 14 }
          }
          # Initialize the staggered update timer at startup.
          set_temp_variable_to_random = {
            var = dr_rand_offset
            min = 1
            max = var:dr_ai_update_frequency
            integer = yes
          }
          set_variable = { dr_days_until_update = var:dr_rand_offset }
          # Perform initial calculation to set correct research slots from day 1.
          recalculate_dynamic_research_slots = yes
        }
      }
    }
  }

  ###
  # Daily update.
  # - Player: recalculate every day, with event cooldown.
  # - AI: roughly every 14 days by default, staggered across countries.
  ###
  on_daily = {
    effect = {
      # Track war duration for dynamic war-time RP penalties.
      if = {
        limit = { has_war = yes }
        add_to_variable = { dr_days_in_war = 1 }
      }
      if = {
        limit = { has_war = no }
        set_variable = { dr_days_in_war = 0 }
      }

      # If a country is created later in the game, initialize it once.
      if = {
        limit = { NOT = { has_country_flag = dynamic_research_slots_initialized } }
        initialize_dynamic_research_slots = yes
        calculate_modifiers_to_rp = yes
        recalculate_dynamic_research_slots = yes
      }

      # Player logic: recalculate every day.
      if = {
        limit = { is_ai = no }

        # Decrease event cooldown (if present).
        if = {
          limit = { has_variable = dr_player_event_cooldown }
          subtract_from_variable = { dr_player_event_cooldown = 1 }
        }

        calculate_modifiers_to_rp = yes
        recalculate_dynamic_research_slots = yes
      }

      # AI logic: recalculate roughly every 14 days by default, staggered.
      # Note: AI countries get an initial calculation at startup (in on_startup),
      # then use staggered updates here for performance optimization.
      if = {
        limit = { is_ai = yes }

        # Ensure AI update frequency variable exists (defensive check for edge cases).
        if = {
          limit = { NOT = { has_variable = dr_ai_update_frequency } }
          set_variable = { dr_ai_update_frequency = 14 }
        }

        # Initialize random offset if not yet set (should be set at startup, but handle edge cases).
        if = {
          limit = { NOT = { has_variable = dr_days_until_update } }
          set_temp_variable_to_random = {
            var = dr_rand_offset
            min = 1
            max = var:dr_ai_update_frequency
            integer = yes
          }
          set_variable = { dr_days_until_update = var:dr_rand_offset }
        }

        subtract_from_variable = { dr_days_until_update = 1 }

        if = {
          limit = {
            check_variable = {
              var = dr_days_until_update
              value = 0
              compare = less_than_or_equals
            }
          }
          set_variable = { dr_days_until_update = var:dr_ai_update_frequency }
          calculate_modifiers_to_rp = yes
          recalculate_dynamic_research_slots = yes
        }
      }
    }
  }
}
